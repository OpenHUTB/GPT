% 生成城市场景
% 第二次运行后出现始终在原点，需要清除之前的内容？：clear global
% 是车辆走得太快了
dbclear if error
fname = 'auto_created_model';
close_system(fname, 0)
h = new_system(fname);
% open_system(fname);%打开模型

refPosesT = ...
  [0 359.61547034041604;
   0.050118254485798923 359.32918629836973;
   0.10002661045430808 359.06364250942755;
   0.14974362961077259 358.81938275019832;
   0.19928761543239423 358.59690892633546;
   0.24867663229016759 358.39667950470039;
   0.29792852578972867 358.21910811664912;
   0.34706094423278055 358.06456232844221;
   0.39609136109310739 357.93336257398391;
   0.4450370983944717 357.82578124465874;
   0.49391535087179472 357.74204193093686;
   0.54274321079201338 357.68231881064708;
   0.59153769330678985 357.64673617933;
   0.64031576220596575 357.63536811884217;
   0.68909435593812118 357.64823830134281;
   0.7378904137629908 357.68531992689742;
   0.786720901899658 357.74653579412728;
   0.83560283953447811 357.83175850455081;
   0.884553324553553 357.94081080245439;
   0.93358955886626349 358.07346605322653;
   0.98272887318890478 358.22944886403519;
   1.0319887511608683 358.40843585147758;
   1.0813868526700225 358.61005656132579;
   1.1309410362690584 358.83389454570005;
   1.1806693805704567 359.07948860288451;
   1.2305902045145611 359.34633418454155;
   1.2807220864127986 359.63388497426286;
   1.3310838816765214 359.94155464022253;
   1.3816947391510825 0.26871876318104509;
   1.4325741159846814 0.61471693924949677;
   1.4837417909719923 0.97885505470453271;
   1.5352178763237354 1.3604077277869995;
   1.5870228278249023 1.7586209098858057;
   1.6391774533562904 2.1727146358665896;
   1.6917029197661861 2.6018859106286869;
   1.7446207580913542 3.0453117163416956;
   1.7979528671386935 3.5021521223049743;
   1.8517215154510749 3.9715534770691225;
   1.9059493416925397 4.4526516604325348;
   1.9606569334778665 5.02539159600415;
   2.0122360029520578 18.99318816486015;
   2.0537903956010504 59.821458622348153;
   2.0988330455643021 86.685606660286012;
   2.1546749287960276 97.842594896671216;
   2.2182366849424087 101.55899495688617;
   2.2836261511764269 101.27724293210234;
   2.3479188047211705 100.59008843124374;
   2.4110705940829038 99.898056026346225;
   2.473123370657166 99.2021881057781;
   2.534118654408299 98.503607394509828;
   2.5940976018328437 97.803515591269772;
   2.6531009735978381 97.103191149332957;
   2.7111691021382884 96.403986168003541;
   2.7683418595259979 95.7073223771436;
   2.8246586259474111 95.014686214098816;
   2.880158259149316 94.327623010595772;
   2.9348790652279604 93.647730326048318;
   2.988858771148426 92.9766504825441;
   3.0421344993860067 92.316062374869375;
   3.0947427450796816 91.667672645541955;
   3.146719356079088 91.033206329260182;
   3.1980995162503207 90.41439708281861;
   3.2489177323826879 89.812977124878671;
   3.2992078250086303 89.230667014659915;
   3.3490029234122107 88.669165399451529;
   3.3983354650595481 88.130138857844457;
   3.4472371996371121 87.6152119589519;
   3.4957391978327546 87.125957648001148;
   3.5438718649401562 86.663888056077326;
   3.5916649593115184 86.230445817140861;
   3.6391476156266447 85.826995959460817;
   3.6863483728903961 85.454818422084628;
   3.7332952070155634 85.11510123066715;
   3.7800155677954805 84.808934351622142;
   3.8265364200211516 84.537304229771976;
   3.8728842884514494 84.301089002964744;
   3.9190853063030966 84.101054377883756;
   3.9651652668895183 83.937850144723541;
   4.0111496780048173 83.812007304629233;
   4.057063818621133 83.723935782732454;
   4.1029327974444723 83.673922701068562;
   4.1487816128557649 83.662131189314309;
   4.1946352137504634 83.688599716728888;
   4.2405185607814637 83.753241935425251;
   4.2864566875062007 83.855847032596927;
   4.3324747609396805 83.996080597005587;
   4.3785981410208814 84.17348601231005;
   4.4248524385106229 84.387486396124189;
   4.4712635708538562 84.637387108503134;
   4.5178578155599851 84.922378856409679;
   4.56466186067956 85.241541421230693;
   4.6117028519855587 85.593848034324353;
   4.6590084365024511 85.978170420737584;
   4.706606802065048 86.393284523630783;
   4.7545267126331581 86.837876911721992;
   4.8027975391353239 87.31055185950639;
   4.8514492856659643 87.809839075547032;
   4.90051261091376 88.33420203833488;
   4.9500188447547586 88.882046882743182;
   5 89.451731763695818];

refPosesX = ...
  [0 -115.01336898395718;
   0.050118254485798923 -112.66350501310359;
   0.10002661045430808 -110.32361335118472;
   0.14974362961077259 -107.9928608206382;
   0.19928761543239423 -105.67041424390165;
   0.24867663229016759 -103.35544044341269;
   0.29792852578972867 -101.04710624160896;
   0.34706094423278055 -98.744578460928068;
   0.39609136109310739 -96.447023923807663;
   0.4450370983944717 -94.153609452685359;
   0.49391535087179472 -91.863501869998771;
   0.54274321079201338 -89.575867998185544;
   0.59153769330678985 -87.289874659683278;
   0.64031576220596575 -85.004688676929632;
   0.68909435593812118 -82.719476872362208;
   0.7378904137629908 -80.433406068418634;
   0.786720901899658 -78.145643087536541;
   0.83560283953447811 -75.855354752153545;
   0.884553324553553 -73.561707884707289;
   0.93358955886626349 -71.263869307635389;
   0.98272887318890478 -68.96100584337546;
   1.0319887511608683 -66.652284314365147;
   1.0813868526700225 -64.336871543042065;
   1.1309410362690584 -62.013934351843844;
   1.1806693805704567 -59.682639563208106;
   1.2305902045145611 -57.342153999572467;
   1.2807220864127986 -54.991644483374571;
   1.3310838816765214 -52.630277837052041;
   1.3816947391510825 -50.257220883042478;
   1.4325741159846814 -47.871640443783548;
   1.4837417909719923 -45.472703341712844;
   1.5352178763237354 -43.059576399268011;
   1.5870228278249023 -40.631426438886663;
   1.6391774533562904 -38.187420283006404;
   1.6917029197661861 -35.726724754064918;
   1.7446207580913542 -33.248506674499779;
   1.7979528671386935 -30.751932866748646;
   1.8517215154510749 -28.236170153249105;
   1.9059493416925397 -25.700385356438844;
   1.9606569334778665 -23.143867950663619;
   2.0122360029520578 -20.764665172621054;
   2.0537903956010504 -19.274483698081418;
   2.0988330455643021 -18.751682681599608;
   2.1546749287960276 -18.901916965215449;
   2.2182366849424087 -19.428102822641854;
   2.2836261511764269 -20.0426379639448;
   2.3479188047211705 -20.61449411359855;
   2.4110705940829038 -21.141166618646793;
   2.473123370657166 -21.623953555699337;
   2.534118654408299 -22.06415300136603;
   2.5940976018328437 -22.463063032256681;
   2.6531009735978381 -22.821981724981129;
   2.7111691021382884 -23.142207156149198;
   2.7683418595259979 -23.42503740237072;
   2.8246586259474111 -23.671770540255512;
   2.880158259149316 -23.883704646413413;
   2.9348790652279604 -24.062137797454248;
   2.988858771148426 -24.208368069987841;
   3.0421344993860067 -24.323693540624024;
   3.0947427450796816 -24.409412285972621;
   3.146719356079088 -24.466822382643464;
   3.1980995162503207 -24.497221907246377;
   3.2489177323826879 -24.501908936391189;
   3.2992078250086303 -24.482181546687727;
   3.3490029234122107 -24.439337814745819;
   3.3983354650595481 -24.374675817175294;
   3.4472371996371121 -24.28949363058598;
   3.4957391978327546 -24.1850893315877;
   3.5438718649401562 -24.062760996790288;
   3.5916649593115184 -23.923806702803567;
   3.6391476156266447 -23.769524526237372;
   3.6863483728903961 -23.601212543701521;
   3.7332952070155634 -23.420168831805846;
   3.7800155677954805 -23.227691467160177;
   3.8265364200211516 -23.025078526374337;
   3.8728842884514494 -22.813628086058159;
   3.9190853063030966 -22.594638222821473;
   3.9651652668895183 -22.369407013274095;
   4.0111496780048173 -22.139232534025854;
   4.057063818621133 -21.905412861686589;
   4.1029327974444723 -21.669246072866127;
   4.1487816128557649 -21.432030244174282;
   4.1946352137504634 -21.195063452220896;
   4.2405185607814637 -20.959643773615788;
   4.2864566875062007 -20.727069284968788;
   4.3324747609396805 -20.498638062889736;
   4.3785981410208814 -20.275648183988441;
   4.4248524385106229 -20.059397724874731;
   4.4712635708538562 -19.851184762158447;
   4.5178578155599851 -19.65230737244941;
   4.56466186067956 -19.464063632357448;
   4.6117028519855587 -19.28775161849239;
   4.6590084365024511 -19.124669407464062;
   4.706606802065048 -18.976115075882294;
   4.7545267126331581 -18.843386700356909;
   4.8027975391353239 -18.727782357497734;
   4.8514492856659643 -18.630600123914608;
   4.90051261091376 -18.553138076217344;
   4.9500188447547586 -18.496694291015782;
   5 -18.462566844919742];

refPosesY = ...
  [0 0.84224598930484262;
   0.050118254485798923 0.82053841506004321;
   0.10002661045430808 0.7876508647564191;
   0.14974362961077259 0.7445174154729165;
   0.19928761543239423 0.692072144288482;
   0.24867663229016759 0.63124912828206181;
   0.29792852578972867 0.5629824445326026;
   0.34706094423278055 0.48820617011905032;
   0.39609136109310739 0.4078543821203518;
   0.4450370983944717 0.32286115761545309;
   0.49391535087179472 0.23416057368330079;
   0.54274321079201338 0.14268670740284117;
   0.59153769330678985 0.04937363585302057;
   0.64031576220596575 -0.044844563887214584;
   0.68909435593812118 -0.13903381473891796;
   0.7378904137629908 -0.23226003962314268;
   0.786720901899658 -0.32358916146094296;
   0.83560283953447811 -0.41208710317337238;
   0.884553324553553 -0.49681978768148394;
   0.93358955886626349 -0.576853137906332;
   0.98272887318890478 -0.65125307676897015;
   1.0319887511608683 -0.71908552719045171;
   1.0813868526700225 -0.77941641209182988;
   1.1309410362690584 -0.83131165439415922;
   1.1806693805704567 -0.873837177018493;
   1.2305902045145611 -0.90605890288588409;
   1.2807220864127986 -0.92704275491738675;
   1.3310838816765214 -0.935854656034055;
   1.3816947391510825 -0.93156052915694132;
   1.4325741159846814 -0.913226297207101;
   1.4837417909719923 -0.879917883105586;
   1.5352178763237354 -0.83070120977345074;
   1.5870228278249023 -0.76464220013174855;
   1.6391774533562904 -0.68080677710153292;
   1.6917029197661861 -0.5782608636038582;
   1.7446207580913542 -0.45607038255977805;
   1.7979528671386935 -0.31330125689034527;
   1.8517215154510749 -0.14901940951661208;
   1.9059493416925397 0.037709236640363186;
   1.9606569334778665 0.24792105722982608;
   2.0122360029520578 0.64842754889096388;
   2.0537903956010504 1.8334076367677488;
   2.0988330455643021 3.8599695899152984;
   2.1546749287960276 6.4699644222158659;
   2.2182366849424087 9.40292669049752;
   2.2836261511764269 12.406709517510802;
   2.3479188047211705 15.366536695607207;
   2.4110705940829038 18.280392593397625;
   2.473123370657166 21.14959791540263;
   2.534118654408299 23.975473366142886;
   2.5940976018328437 26.759339650138998;
   2.6531009735978381 29.502517471911606;
   2.7111691021382884 32.206327535981345;
   2.7683418595259979 34.872090546868847;
   2.8246586259474111 37.501127209094719;
   2.880158259149316 40.094758227179639;
   2.9348790652279604 42.654304305644224;
   2.988858771148426 45.181086149009055;
   3.0421344993860067 47.676424461794824;
   3.0947427450796816 50.141639948522112;
   3.146719356079088 52.578053313711614;
   3.1980995162503207 54.986985261883909;
   3.2489177323826879 57.369756497559621;
   3.2992078250086303 59.727687725259429;
   3.3490029234122107 62.062099649503914;
   3.3983354650595481 64.374312974813748;
   3.4472371996371121 66.665648405709561;
   3.4957391978327546 68.937426646711913;
   3.5438718649401562 71.190968402341525;
   3.5916649593115184 73.427594377119;
   3.6391476156266447 75.648625275564925;
   3.6863483728903961 77.855381802199986;
   3.7332952070155634 80.049184661544786;
   3.7800155677954805 82.231354558119989;
   3.8265364200211516 84.403212196446177;
   3.8728842884514494 86.566078281044028;
   3.9190853063030966 88.721273516434081;
   3.9651652668895183 90.8701186071371;
   4.0111496780048173 93.01393425767364;
   4.057063818621133 95.154041172564334;
   4.1029327974444723 97.291760056329821;
   4.1487816128557649 99.428411613490738;
   4.1946352137504634 101.56531654856772;
   4.2405185607814637 103.70379556608138;
   4.2864566875062007 105.84516937055234;
   4.3324747609396805 107.99075866650124;
   4.3785981410208814 110.14188415844875;
   4.4248524385106229 112.29986655091545;
   4.4712635708538562 114.46602654842202;
   4.5178578155599851 116.64168485548905;
   4.56466186067956 118.82816217663719;
   4.6117028519855587 121.02677921638707;
   4.6590084365024511 123.23885667925926;
   4.706606802065048 125.46571526977448;
   4.7545267126331581 127.70867569245333;
   4.8027975391353239 129.9690586518164;
   4.8514492856659643 132.24818485238441;
   4.90051261091376 134.54737499867792;
   4.9500188447547586 136.86794979521761;
   5 139.211229946524];

% 获取三维场景配置模块的对话框参数列表。
% dialog_params = get_param('auto_created_model/test', 'DialogParameters');

% 要获取库模块路径，可以将鼠标悬停在库浏览器中的模块上
add_block('drivingsim3d/Simulation 3D Scene Configuration', 'auto_created_model/test');
set_param('auto_created_model/test', 'SceneDesc', 'US city block');

add_block('drivingsim3d/Simulation 3D Vehicle with Ground Following', 'auto_created_model/vehicle1');
% 将工作区的变量保存为.m文件
% Simulink.saveVars('X_Y_T.m', 'refPosesX', 'refPosesY', 'refPosesT');
% get_param('auto_created_model/x1', 'DialogParameters')
% get_param('auto_created_model/x1', 'ObjectParameters')
% 
add_block('simulink/Sources/From Workspace', 'auto_created_model/x1', 'VariableName', 'refPosesX');
add_block('simulink/Sources/From Workspace', 'auto_created_model/y1', 'VariableName', 'refPosesY');
add_block('simulink/Sources/From Workspace', 'auto_created_model/t1', 'VariableName', 'refPosesT');
% get_param('auto_created_model/x1','ObjectParameters');

add_line('auto_created_model', 'x1/1', 'vehicle1/1')
add_line('auto_created_model', 'y1/1', 'vehicle1/2')
add_line('auto_created_model', 't1/1', 'vehicle1/3')

% add_block('drivingsim3d/Simulation 3D Vehicle with Ground Following', 'auto_created_model/vehicle2');
% add_block('simulink/Sources/From Workspace', 'auto_created_model/x2');
% add_block('simulink/Sources/From Workspace', 'auto_created_model/y2');
% add_block('simulink/Sources/From Workspace', 'auto_created_model/t2');


% "D:\work\workspace\gpt\sim\WindowsNoEditor\AutoVrtlEnv_with_cmd.exe" -AudioMixer -PixelStreamingIP=localhost -PixelStreamingPort=8888
% set_param('auto_created_model/test', 'ScenePath', 'D:\project\all_maps\WindowsNoEditor\AutoVrtlEnv.exe');  % Scene view— 配置显示场景的虚拟摄像机的放置

% get_param('auto_created_model/test', 'vehTag')

sim(fname);

% 将文件在当前文件夹中保存为.slx文件
% save_system(fname);

%  0 表示关闭而不保存
close_system(fname, 0)